@*@model GeHosContract.Contrato*@


@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.Title = "Agregar Agenda";
}

<section class="content">

    @*Row Header *@
    <div class="row">
        <div class="col-xs-12">
            <h2 class="page-header">
                <i class="fa fa-calendar-o"></i> Nueva Agenda.
                <small class="pull-right">@DateTime.Now.ToShortDateString()</small>
            </h2>
        </div>
    </div>
    @*Fin-Row Header *@


    @*Inicio Form*@
    <form id="formAgenda">
        @*onsubmit="submitAgenda()"*@
        @*@Html.AntiForgeryToken()*@

        @*Box Datos Generales*@
        <div class="box box-primary">

            @*Box Header*@
            <div class="box-header with-border">
                <h3 class="box-title">Datos Generales</h3>
            </div>
            @*Fin - Box Header*@



            @*Box-body*@
            <div class="box-body">


                @Html.ValidationSummary(true, "", new { @class = "text-danger" })

                @*Profesional*@
                <div class="form-group">
                    @Html.Label("Profesional", htmlAttributes: new { @class = "control-label " })
                    @Html.DropDownList("CentroDeSaludID", (SelectList)(ViewBag.ListaCentroSalud), new { @class = "form-control", @id = "CentroDeSaludNombre" })   @*, @style="width: 100%"*@
                    @*@Html.ValidationMessageFor(model => model.CentroDeSaludNombre, "", new { @class = "text-danger" })*@
                </div>
                @*Fin - Profesional*@

                @*Especialidad*@
                <div class="form-group">
                    @Html.Label("Especialidad", htmlAttributes: new { @class = "control-label " })
                    @Html.DropDownList("EspecialidadID", (SelectList)(ViewBag.Especialidad), new { @class = "select2 form-control" })
                    @*@Html.ValidationMessageFor(model => model.EspecialidadNombre, "", new { @class = "text-danger" })*@
                </div>
                @*Fin - Especialidad*@

                @*Fechas*@
                <div class="row">
                    @*Fechas Desde*@
                    <div class='col-md-6'>
                        <div class="form-group">
                            @Html.Label("Fecha Desde", htmlAttributes: new { @class = "control-label" })
                            <div class='input-group date' id='dpFechaDesde'>
                                <input type='text' class="form-control" required />
                                <span class="input-group-addon">
                                    <span class="fa fa-calendar"></span>
                                </span>
                            </div>
                        </div>
                    </div>
                    @*Fin - Fechas Desde*@

                    @*Fechas Hasta*@
                    <div class='col-md-6'>
                        <div class="form-group">
                            @Html.Label("Fecha Hasta", htmlAttributes: new { @class = "control-label" })
                            <div class='input-group date' id='dpFechaHasta'>
                                <input type='text' class="form-control" required />
                                <span class="input-group-addon">
                                    <span class="fa fa-calendar"></span>
                                </span>
                            </div>
                        </div>
                    </div>
                    @*Fin - Fechas Hasta*@

                </div>
                @**Fin - Fechas*@

            </div>
            @*Fin - Box-body*@

        </div>
        @*Fin - Box Datos Generales*@

        @*Box Rango Horario*@
        <div class="box box-info rangoHorario" id="boxHorario_1">

            @*Box Header*@
            <div class="box-header with-border">
                <h3 class="box-title">Rango Horario</h3>

                <div class="box-tools pull-right">
                    <button type="button" class="btn btn-box-tool" data-widget="collapse" data-toggle="tooltip" title="Minimizar">
                        <i class="fa fa-minus"></i>
                    </button>
                </div>
            </div>
            @*Fin - Box Header*@


            @*Box-body*@
            <div class="box-body">

                @*Dias/Duracion de Turnos*@
                <div class="row">
                    @*Dias*@
                    <div class="col-md-7">
                        @Html.Label("Dias", htmlAttributes: new { @class = "control-label" })
                        <div class="col-md-offset-1">
                            <label class="checkbox-inline">
                                @Html.CheckBox("Lunes", new { @value = 1, @class = "chk_1" }) Lunes
                            </label>
                            <label class="checkbox-inline">
                                @Html.CheckBox("Martes", new { @value = 2, @class = "chk_1" }) Martes
                            </label>
                            <label class="checkbox-inline">
                                @Html.CheckBox("Miercoles", new { @value = 3, @class = "chk_1" }) Miercoles
                            </label>
                            <label class="checkbox-inline">
                                @Html.CheckBox("Jueves", new { @value = 4, @class = "chk_1" }) Jueves
                            </label>
                            <label class="checkbox-inline">
                                @Html.CheckBox("Viernes", new { @value = 5, @class = "chk_1" }) Viernes
                            </label>
                            <label class="checkbox-inline">
                                @Html.CheckBox("Sabado", new { @value = 6, @class = "chk_1" }) Sabado
                            </label>
                            <label class="checkbox-inline">
                                @Html.CheckBox("Domingo", new { @value = 0, @class = "chk_1" }) Domingo
                            </label>
                        </div>
                    </div>
                    @*Fin - Dias*@

                    @* Duracion de Turnos *@
                    <div class="col-md-3 col-md-offset-1">
                        <div class="form-group">
                            <label>Duracion de Turnos(en minutos)</label>
                            <input id="dur_tur_1" type="number" class="form-control">
                        </div>
                    </div>
                    @* Fin - Duracion de Turnos *@
                </div>
                @*Fin - Dias/Duracion de Turnos*@

                @*Horarios/Tipo Agenda*@
                <div class="row">

                    @*Hora Desde*@
                    <div class='col-md-4'>
                        <div class="form-group">
                            @Html.Label("Hora Desde", htmlAttributes: new { @class = "control-label" })
                            <div class='input-group date' id='dpHoraDesde_1'>
                                <input type='text' class="form-control" required />
                                <span class="input-group-addon">
                                    <span class="fa fa-clock-o"></span>
                                </span>
                            </div>
                        </div>
                    </div>
                    @*Fin -Hora Desde*@

                    @*Hora Hasta*@
                    <div class='col-md-4'>
                        <div class="form-group">
                            @Html.Label("Hora Hasta", htmlAttributes: new { @class = "control-label" })
                            <div class='input-group date' id='dpHoraHasta_1'>
                                <input type='text' class="form-control" required />
                                <span class="input-group-addon">
                                    <span class="fa fa-clock-o"></span>
                                </span>
                            </div>
                        </div>
                    </div>
                    @*Fin -Hora Hasta*@

                    @*Tipo Agenda*@
                    <div class='col-md-4'>
                        <div class="form-group">
                            @Html.Label("Tipo Agenda", htmlAttributes: new { @class = "control-label" })
                            @Html.DropDownList("Tipo Agenda", (SelectList)(ViewBag.ListaTipoAgendaDeProfesionales), new { @class = "form-control", @id = "tipoAge_1" })
                            @*@Html.ValidationMessageFor(model => model.CentroDeSaludNombre, "", new { @class = "text-danger" })*@
                        </div>
                    </div>
                    @*Fin - Tipo Agenda*@

                </div>
                @*Fin - Horarios/Tipo Agenda*@

            </div>
            @*Fin - Box-body*@

        </div>
        @*Fin - Box Rango Horario*@



        @*Agregar Horario*@
        <div id="divAddAgenda">
            <div class="btn btn-success btn-circle" id="btnAddAgenda"><i class="fa fa-plus"></i></div>
            <b>Nuevo Rango Horario</b>
        </div>
        @*Fin - Agregar Horario*@


        @*Box-footer*@
        <div class="box-footer text-center">
            <button type="submit" class="btn btn-primary ">Guardar</button>
            <button class="btn btn-danger ">Cancelar</button>
        </div>
        @*Fin - Box-footer*@



    </form>@*Fin Form*@









</section>


@section Styles{
    <link href="~/Content/bootstrap-datetimepicker.min.css" rel="stylesheet" />

    <style>
        .btn-circle {
            width: 30px;
            height: 30px;
            text-align: center;
            padding: 6px 0;
            font-size: 12px;
            line-height: 1.428571429;
            border-radius: 15px;
        }

        #divAddAgenda {
            margin-bottom: 15px;
        }
    </style>
}

@section Scripts {
    @Scripts.Render("~/Scripts/moment.min.js")
    @Scripts.Render("~/Scripts/moment-with-locales.min.js")
    @Scripts.Render("~/Scripts/bootstrap-datetimepicker.js")

    <script>
        var boxHorariosCount = 1;
        $(document).ready(function () {

            //Almaceno el estado original del box de Rango Horario
            var $original = $('#boxHorario_1').clone();


            //$('#CentroDeSaludNombre').select2();
            //$('#EspecialidadNombre').select2();


            /////////////DateTimePicker Functions/////////////
            $('#dpFechaDesde').datetimepicker({
                format: "DD/MM/YYYY",
                locale: 'es',
            });

            $('#dpFechaHasta').datetimepicker({
                format: "DD/MM/YYYY",
                locale: 'es',
                useCurrent: false //Important! See issue #1075
            });

            $("#dpFechaDesde").on("dp.change", function (e) {
                $('#dpFechaHasta').data("DateTimePicker").minDate(e.date);
            });

            $("#dpFechaHasta").on("dp.change", function (e) {
                $('#dpFechaDesde').data("DateTimePicker").maxDate(e.date);
            });

            InitTimePicker("dpHoraDesde_1", "dpHoraHasta_1");
            /////////////End - DateTimePicker Functions/////////////


            //Agrega nuevo Box de Rango Horario
            $("#btnAddAgenda").click(function () {
                //debugger;
                ClonaRangoHorario($original);
            });


            $("#formAgenda").submit(function (e) {
                //debugger;
                submitAgenda(e);
            });
        });




        //Función de clonado HTML para Box De Rango Horario
        function ClonaRangoHorario($original) {
            boxHorariosCount++;


            //Clono el box original de Rango Horario
            var $clon = $original.clone();


            //Agrego boton para cerrar box
            $clon.find(".box-tools").append('<button type="button" id="btnCerrar_' + boxHorariosCount + '" class="btn btn-box-tool" data-widget="remove" data-toggle="tooltip" title="" data-original-title="Cerrar"><i class="fa fa-times"></i></button>');

            //Cambio ID del HTML clonado
            $clon.attr("id", "boxHorario_" + boxHorariosCount);

            //Cambio Texto del titulo del HTML clonado
            $clon.find("h3.box-title").text("Rango Horario(" + boxHorariosCount + ")")

            //Cambio Clases para Checks
            $clon.find(".chk_1").each(function (e) {
                $(this).removeClass("chk_1").addClass("chk_" + boxHorariosCount);

            });

            //Cambio ID del Input Cant Turnos
            $clon.find("#dur_tur_1").attr("id", "dur_tur_" + boxHorariosCount);

            //Cambio ID del Input Hora Desde
            $clon.find("#dpHoraDesde_1").attr("id", "dpHoraDesde_" + boxHorariosCount);

            //Cambio ID del Input Hora Hasta
            $clon.find("#dpHoraHasta_1").attr("id", "dpHoraHasta_" + boxHorariosCount);

            //Cambio ID del Input Tipo Agenda
            $clon.find("#tipoAge_1").attr("id", "tipoAge_" + boxHorariosCount);


            $clon.hide();
            $clon.insertBefore($("#divAddAgenda"));
            $clon.fadeIn(1000);
            //debugger
            $clon.animate({ scrollTop: $("#boxHorario_" + boxHorariosCount).position().top }, 1000);


            InitTimePicker("dpHoraDesde_" + boxHorariosCount, "dpHoraHasta_" + boxHorariosCount);
            InitBtnClose("btnCerrar_" + boxHorariosCount, boxHorariosCount);
        }

        //Función de inicialización de TimePicker
        function InitTimePicker(desde, hasta) {
            $("#" + desde).datetimepicker({
                format: "LT",
                locale: 'es',
            });

            $("#" + hasta).datetimepicker({
                format: "LT",
                locale: 'es',
                useCurrent: false //Important! See issue #1075
            });


            $("#" + desde).on("dp.change", function (e) {
                $("#" + hasta).data("DateTimePicker").minDate(e.date);
            });

            $("#" + hasta).on("dp.change", function (e) {
                $("#" + desde).data("DateTimePicker").maxDate(e.date);
            });

        }

        //Función de inicialización de Boton "Cerrar"
        function InitBtnClose(btn, nro_box) {
            $("#" + btn).click(function (e) {
                $("#boxHorario_" + nro_box).remove();
                e.preventDefault();
            });

            //$("#btnCerrar_2").click(function (e) {
            //    debugger
            //    $("#boxHorario_2").remove();
            //    e.preventDefault();
            //});
        }


        //SubmitAgenda
        function submitAgenda(e) {

            //debugger

            //Datos Generales
            var data = {
                ProfesionalID: $("#ProfesionalID").val(),
                EspecialidadID: $("#EspecialidadID").val(),
                FechaDesde: $("#dpFechaDesde").data('date'),
                FechaHasta: $("#dpFechaHasta").data('date'),
                RangosHorarios: []
            };

            //Rangos Horarios
            for (var i = 1; i <= boxHorariosCount; i++) {
                if ($("#boxHorario_" + i).length == 1) {

                    rangoHorario = {
                        id: i,
                        dias: [],
                        DuracionDeTurnos: $("#dur_tur_" + i).val(),
                        AgendaTipoID: $("#tipoAge_" + i).val(),
                        HoraDesde: $("#dpHoraDesde_" + i).data('date'),
                        HoraHasta: $("#dpHoraHasta_" + i).data('date'),
                    }

                    $("input[class=chk_" + i + "]:checked").each(function () {
                        rangoHorario.dias.push(this.value);
                    });

                    data.RangosHorarios.push(rangoHorario);
                }
            }//End "For"


            //debugger
            ValidaFormAgenda(data);

            //var url = '@Url.Action("Agregar", "Agenda")'; // the script where you handle the form input.
            //
            //$.ajax({
            //    type: "POST",
            //    url: url,
            //    data: data, // serializes the form's elements.
            //    success: function (data) {
            //        debugger
            //        alert("volvio del controller"); // show response from the php script.
            //    }
            //});

            e.preventDefault(); // avoid to execute the actual submit of the form.

        }

        function ValidaFormAgenda(data) {

            //Valida

            ValidaSolapamiento(data);
        }

        function ValidaSolapamiento(data) {

            for (var i = 0; i < data.RangosHorarios.length; i++) {

                if ((i + 1) < data.RangosHorarios.length) {
                    for (var j = i + 1; j < data.RangosHorarios.length; j++) {

                        //Devuelve un array con la interseccion de dias
                        var days_intersect = intersect_safe(data.RangosHorarios[i].dias.sort(), data.RangosHorarios[j].dias.sort());
                        //debugger

                        //Si existen dias q se intersectan, verifico solapamiento de Horarios
                        if (days_intersect.length > 0) {
                            //rango horario (i)
                            var hraDesde_1 = parseFloat(data.RangosHorarios[i].HoraDesde.replace(":", "."));
                            var hraHasta_1 = parseFloat(data.RangosHorarios[i].HoraHasta.replace(":", "."));

                            //rango horario (i+1)
                            var hraDesde_2 = parseFloat(data.RangosHorarios[j].HoraDesde.replace(":", "."));
                            var hraHasta_2 = parseFloat(data.RangosHorarios[j].HoraHasta.replace(":", "."));

                            //if(start_times1 <= end_times2 && end_times1 >= start_times2) {}
                            if (hraDesde_1 < hraHasta_2 && hraHasta_1 > hraDesde_2) {
                                //hay solapamiento!!
                                //debugger
                                console.log("---------------------------------------------------------");
                                console.log("Hay solapamiento!!");
                                console.log('Entre "Rango Horario (' + data.RangosHorarios[i].id + ')" y "Rango Horario (' + data.RangosHorarios[j].id + ')"');
                                console.log("en el/los dias: " + days_intersect);
                                console.log("---------------------------------------------------------\n");
                            }
                        }
                    }
                }
            }
        }


        /* finds the intersection of
         * two arrays in a simple fashion.
         *
         * PARAMS
         *  a - first array, must already be sorted
         *  b - second array, must already be sorted
         *
         * NOTES
         *
         *  Should have O(n) operations, where n is
         *    n = MIN(a.length(), b.length())
         */
        function intersect_safe(a, b) {
            var ai = 0, bi = 0;
            var result = [];

            while (ai < a.length && bi < b.length) {
                if (a[ai] < b[bi]) { ai++; }
                else if (a[ai] > b[bi]) { bi++; }
                else /* they're equal */
                {
                    result.push(a[ai]);
                    ai++;
                    bi++;
                }
            }

            return result;
        }
    </script>
}